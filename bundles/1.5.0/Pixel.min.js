/**
  * Created by Joshua Barnett
  * 
  * Licensed under MIT, 2019
  * All Rights reserved
  */'use strict';class SpriteBase{constructor(a=!1){this.point=new Point,this.anchor=new Point,this.opacity=1,this.deg=0,this.scale=1,this.noscale=a,this.flipX=!1,this.flipY=!1}setSize(a,b){this.width=a,this.height=b}get x(){return this.point.x}set x(a){return this.point.x=a}get y(){return this.point.y}set y(a){return this.point.y=a}setAnchor(a,b){this.anchor.x=a,this.anchor.y=b}copy(a){this.point=a.point,this.deg=a.deg,this.anchor=a.anchor,this.flipX=a.flipX,this.flipY=a.flipY,this.opacity=a.opacity,this.scale=a.scale}spin(a){this.deg=360*a}settings(a){this.noscale||(a.globalAlpha=this.opacity),a.scale(this.scale,this.scale)}reset(a){a.globalAlpha=1,this.noscale||a.scale(1/this.scale,1/this.scale)}}class Circle extends SpriteBase{constructor(a,b="#000000"){super(!0),this.radius=a,this.color=b}render(a){this.settings(a),a.beginPath(),a.fillStyle=this.color,a.arc(this.x,this.y,this.radius,0,2*Math.PI),a.fill(),this.reset(a)}}class Point{constructor(a=0,b=0){this.x=a,this.y=b}clone(){return new Point(this.x,this.y)}}class Rectangle extends SpriteBase{constructor(a,b,d="#000000"){super(!0),this.width=a,this.height=b,this.color=d}render(a){this.settings(a),0<this.deg||this.flipX||this.flipY?this.rotation_render(a):(a.fillStyle=this.color,a.fillRect(this.x-this.width*this.anchor.x,this.y-this.height*this.anchor.y,this.width,this.height),a.fill()),this.reset(a)}rotation_render(a){a.save(),a.translate(this.x,this.y),this.flipX&&a.scale(-1,1),this.flipY&&a.scale(1,-1),a.rotate(Math.PI/180*this.deg),a.fillStyle=this.color,a.fillRect(0-this.width*this.anchor.x,0-this.height*this.anchor.y,this.width,this.height),a.fill(),a.restore()}}class Container{constructor(a){let b=this;this.sprites=[],this._backColor="#FFFFFF",this.ctx=a,this.container=!0,this.regions={},this.keyboard={},this.mousePos=function(a,b){var c=a.getBoundingClientRect(),d=a.width/c.width,e=a.height/c.height;return{x:(b.clientX-c.left)*d,y:(b.clientY-c.top)*e}},this.background=function(a){b._backColor=a},this.add=function(a){return a.render(this.ctx)},this.clear=function(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)},this.on=function(a,c){"mousemove"===a||"mousedown"===a||"click"===a?b["on"+a]=c:b.view.addEventListener(a,c)},this.keyboard.on=function(a,c){"keydown"===a||"keyup"===a?b["on"+a]=c:document["on"+a]=c},this.addHitRegion=function(a,c){b.stage.regions[a.name]=Object(Object.assign({call:c},a))}}addChild(a){this.sprites.push(a)}cloneChildren(a){var b=this.contents;for(var c in b)a.addChild(b[c])}render(){var a=this.sprites;for(var b in a)a[b].render(this.ctx)}}class Stage{constructor(a){var b=this,d=document.createElement("canvas");d.height=a.height,d.width=a.width;var e=d.getContext("2d");this.view=e.canvas,this.draw=e,this.tick=!!(null|a.ticker===void 0)||a.ticker,this.cursor=d.style.cursor,this.resources={},this.stage=new Container(this.draw),this.physics={collisions:[],colliding:{}},this.physics.collider={},this.physics.collider.add=function(a,c,d){b.physics.collisions.push({name:a,parent:c,child:d}),b.physics.colliding[a]=!1},this._checkRegions=function(a,e=!0){var f=!1,g=b.stage.mousePos(d,a);for(var h in b.stage.mouse=g,b.stage.regions){var i=b.stage.regions[h];g.x>i.start.x&&g.x<i.end.x&&g.y>i.start.y&&g.y<i.end.y&&(e?i.call():d.style.cursor="pointer",f=!0)}return f},this.view.onclick=function(a){if(b._checkRegions(a),b.onclick)return b.onclick(a)},document.onmousemove=function(a){var c=b._checkRegions(a,!1);if(c||(d.style.cursor=b.cursor),b.stage.onmousemove)return b.stage.onmousemove(a)},document.onmousedown=function(a){if(b.lastClickTarget=a.target,b.stage.onmousedown)return b.stage.onmousedown(a)},document.onkeydown=function(a){let c=a.key,d=_pixel_keys;for(var e in d)c===d[e]&&(d.down[e]=!0);if(b.stage.onkeydown)return b.stage.onkeydown(a)},document.onkeyup=function(a){let c=a.key,d=_pixel_keys;for(var e in d)c===d[e]&&(d.down[e]=!1);if(b.stage.onkeyup)return b.stage.onkeyup(a)},this.resources.add=function(a,c){var d=new Image;return new Promise(function(e){d.onload=function(){return b.resources[a]={image:d,renderable:!0},e(b.resources)},d.crossOrigin="Anonymous",d.src=c})},(null|a.ticker===void 0||a.ticker)&&this._animFrame(this)}addChild(a){this.stage.addChild(a)}render(a){var b=a.stage.sprites.length;1<=b&&a.stage.clear(),a.draw.fillStyle=a.stage._backColor,a.draw.fillRect(0,0,a.view.width,a.view.height);for(var c=0;c<b;c++)a.stage.sprites[c].render(a.draw)}_checkCollisions(a){for(let b in a.physics.collisions){let c=a.physics.collisions[b],d=c.name,e=c.parent,f={top:!1,bottom:!1,left:!1,right:!1,body:!1};if(Array.isArray(e))for(let a in e){let b=e[a],d=b.checkCollisions(c.child);f.body=!0===d.body||!0===f.body,f.left=!0===d.left||!0===f.left,f.right=!0===d.right||!0===f.right,f.bottom=!0===d.bottom||!0===f.bottom,f.top=!0===d.top||!0===f.top}else f=e.checkCollisions(c.child);a.physics.colliding[d]=f}}_animFrame(a){a.render(a),requestAnimationFrame(a._checkCollisions.bind(!1,a)),requestAnimationFrame(a._tick.bind(!1,a)),requestAnimationFrame(a._animFrame.bind(!1,a))}_tick(a){a.tick&&a.tick()}}class AnimationCore{constructor(a){this.parent=a,this.frame=0,this.cache=[],this.tracks={},this.current=!1,this.track=""}stop(a){let b=new Sprite({renderable:!0,image:this.cache[a-1].image});this.current=[b],this.frame=0}play(a){this.track!==a&&(this.frame=0),this.current=this.tracks[a],this.track=a}add(a,b,c=0){var d=c,e=this.cache,f=[];for(var g in e){var h=e[g];if(h.name.startsWith(b)&&0===d){var i=new Sprite({renderable:!0,image:h.image});f.push(i)}else 0<d&&d--}0<f.length&&(this.tracks[a]=f)}create(a){let b=a.name,c=a.positions[0],d=a.positions[1],e=this.cache,f=[];for(var g,h=c-1;h<d;h++)g=new Sprite({renderable:!0,image:e[h].image}),f.push(g);this.tracks[b]=f}multiAdd(a){for(var b in a){let c=a[b],d=c.name,e=c.filter,f=c.offset;this.add(d,e,f)}}}class AnimatedSprite extends SpriteBase{constructor(a,b,c=.15){super(),this.animation=new AnimationCore(this),this.speed=c,this.texture={image:new Image},this.config?(this.config=a,this.texture=b,this._splitFrames()):(this.sheet=b,this._splitSheetFrames())}_splitFrames(){var a=this.config,b=this;for(var c in a.textures[0].frames){let d=a.textures[0].frames[c];this.animation.cache.push({name:d.name,image:b._slice(d.position.x,d.position.y,d.position.w,d.position.h)})}}_splitSheetFrames(){var a=this;for(var b in a.sheet){let c=a.sheet[b];this.animation.cache.push({name:b.toString(),image:c})}}_slice(a,b,c,d){var e=document.createElement("canvas"),f=e.getContext("2d");f.canvas.width=this.texture.image.width,f.canvas.height=this.texture.image.height,f.drawImage(this.texture.image,0,0);var g=f.getImageData(a,b,c,d);return f.clearRect(0,0,this.texture.image.width,this.texture.image.height),e.width=c,e.height=d,f.putImageData(g,0,0),e}render(a){if(this.animation.current){var b=this.animation.current[Math.floor(this.animation.frame)%this.animation.current.length];b.copy(this),this.texture=b.texture,b.render(a),this.animation.frame+=this.speed}}}class SpriteSheet extends SpriteBase{constructor(a,b){super(),this.texture=a,this.sheet=[],this._parse(b)}_slice(a,b,c,d,e=!1){let f=e||this.texture,g=document.createElement("canvas"),h=g.getContext("2d");h.canvas.width=f.width?f.width:f.image.width,h.canvas.height=f.height?f.height:f.image.height,h.drawImage(f.width?f:f.image,0,0);let i=h.getImageData(a,b,c,d);return g.width=c,g.height=d,h.putImageData(i,0,0),g}trim(a){let b=a.width,c=a.height,d=this.sheet[0].width,e=this.sheet[0].height;for(let f in this.sheet){let a=this.sheet[f],g=d-b,h=e-c;this.sheet[f]=this._slice(g/2,h/2,b-g/2,c-h/2,a)}}_parse(a){var b=Math.floor;let c,d,e=this.texture.image.width,f=this.texture.image.height,g=b(e/a.width),h=b(f/a.height),i=a.margin||0,j=a.spacing||0;for(d=1;d<=h;d++)for(c=1;c<=g;c++){let b=this._slice(c*(a.width+j)-a.width,d*(a.height+j+i)-a.height,a.width-i-j,a.height-i-j);this.sheet.push(b)}}generateSheet(){return this.sheet}}class Sprite$1 extends SpriteBase{constructor(a){super(),this.texture=a}render(a){this.texture.renderable&&(this.settings(a),0<this.deg||this.flipX||this.flipY?this.rotation_render(a):a.drawImage(this.texture.image,this.x/this.scale-this.texture.image.width*this.anchor.x,this.y/this.scale-this.texture.image.height*this.anchor.y),this.reset(a))}rotation_render(a){var b=this.texture.image;a.save(),a.translate(this.x/this.scale,this.y/this.scale),this.flipX&&a.scale(-1,1),this.flipY&&a.scale(1,-1),a.fillStyle="#000000",a.rotate(Math.PI/180*this.deg),a.drawImage(b,-b.width*this.anchor.x,-b.height*this.anchor.y),a.restore()}checkCollisions(a){var b=this.x/this.scale-this.texture.image.width*this.anchor.x,c=b+this.texture.image.width,d=this.y/this.scale-this.texture.image.height*this.anchor.y,e=d+this.texture.image.height,f=a.x/a.scale-(a.width||a.texture.image.width)*a.anchor.x,g=f+(a.width||a.texture.image.width)/a.scale,h=a.y/a.scale-(a.height||a.texture.image.height)*a.anchor.y,i=h+(a.height||a.texture.image.height)/a.scale,j=!0,k=!1,l=!1,m=!1,n=!1;return(e<h||d>i||c<f||b>g)&&(j=!1),j&&(e-0>i&&d+0<i&&(n=!0),d+0<h&&e-0>h&&(m=!0),b+0<f&&c-0>f&&(k=!0),c-0>g&&b+0<g&&(l=!0)),{body:j,left:k,right:l,top:m,bottom:n}}clone(){let a=new Sprite$1(this.texture);return a.copy(this),a}}class Texture{constructor(a){var b=this;this.image=new Image,this.renderable=!1,this.image.onload=function(){b.renderable=!0},this.image.src=a}}class Text extends SpriteBase{constructor(a,b,d="#000000"){super(),this.text=a,this.size=b,this.color=d}render(a){this.settings(a),a.beginPath(),a.fillStyle=this.color,a.font=this.size+"px Verdana",a.fillText(this.text,this.x,this.y),a.fill(),this.reset(a)}}class Sound{constructor(){}}class FillStyle{constructor(){this.color,this.alpha,this.reset()}reset(){this.color=16777215,this.alpha=1}clone(){var a=new FillStyle;return a.color=this.color,a.alpha=this.alpha,a}fill(a){return this.color=a,this.color}}class ImageGraphics{constructor(){this.cctx,this.canvas,this.image=new Image,this.renderable=!1,this.width=0,this.height=0}loadImage(a){var b=this;return new Promise(function(c){b.image.onload=function(){return b.renderable=!0,b.math=!0,b.width=b.image.width,b.height=b.image.height,c(b)},b.image.src=a})}cropRect(a,b,c,d){var e=this;this.canvas=document.createElement("canvas"),this.cctx=this.canvas.getContext("2d"),this.cctx.canvas.width=this.width,this.cctx.canvas.height=this.height,this.cctx.drawImage(this.image,0,0);var f=this.cctx.getImageData(a,b,c,d);return this.cctx.clearRect(0,0,this.width,this.height),this.canvas.width=c,this.canvas.height=d,this.cctx.putImageData(f,0,0),new Sprite$1({renderable:!0,image:e.canvas})}}class Graphics extends ImageGraphics{constructor(a){super(),this.ctx=a,this.dsc=this.ctx.shadowColor,this._fillStyle=new FillStyle}transparency(a){return this.ctx.globalAlpha=a,this}shadow(a,b,c,d){return this.ctx.shadowBlur=a,this.ctx.shadowColor=b,this.ctx.shadowOffsetX=c,this.ctx.shadowOffsetY=d,this}fill(a){return this.ctx.fillStyle=this._fillStyle.fill(a),this}end(){this._fillStyle.reset(),this.ctx.fillStyle="#000000",this.ctx.shadowBlur=0,this.ctx.shadowColor=this.dsc,this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0,this.ctx.globalAlpha=1}drawRect(e,a,b,c){return this.ctx.fillRect(e,a,b,c),this}arc(g,a,b,c,d,e=!1){return this.ctx.beginPath(),this.ctx.arc(g,a,b,c,d,e),this.ctx.fill(),this}arcTo(f,a,b,c,d){return this.ctx.beginPath(),this.ctx.arcTo(f,a,b,c,d),this.ctx.fill(),this}move(c,a){return this.ctx.moveTo(c,a),this}clearRect(a,b,c,d){return this.ctx.clearRect(a,b,c,d),this}clearCircle(a,b,c){this.ctx.globalCompositeOperation="destination-out",this.ctx.arc(a,b,c,0,2*Math.PI),this.ctx.fill(),this.ctx.globalCompositeOperation="source-over"}}class Map extends SpriteBase{constructor(a,b){super(),this.sheet=a,this.data=b,this.tiles=[],this.exclude,this.colliders=[]}_includeCollider(a,b){if(this.exclude){let c=!(-1<this.exclude.indexOf(a));c&&this.colliders.push(b)}}applyTileset(a){let b=this.data.height,c=this.data.width,d=this;for(var e=0;e<b;e++){for(var f=0;f<c;f++){let b=a[e][f],c=!!this.sheet[b]&&new Sprite$1({image:d.sheet[b],renderable:!0});this.tiles.push(c),c&&this._includeCollider(b,c)}f=0}}generateBlankMap(){for(var a=0;a<this.data.height;a++)for(var b=0;b<this.data.width;b++)this.tiles.push(!1)}collideByExclusion(a){this.exclude=a}checkCollisions(a){let b={body:!1,top:!1,bottom:!1,left:!1,right:!1};for(let c=0;c<this.colliders.length;c++){let d=this.colliders[c],e=d.checkCollisions(a);b.body=!(!0!==e.body&&!0!==b.body),b.left=!(!0!==e.left&&!0!==b.left),b.right=!(!0!==e.right&&!0!==b.right),b.bottom=!(!0!==e.bottom&&!0!==b.bottom),b.top=!(!0!==e.top&&!0!==b.top)}return b}_match(a,b){var c=Math.floor;let d=Math.random()*a;for(var e=0,f=-1,g=0;g<b.length;g++)if(e+=b[g].weight,d<=e){var h=b[g].index;f=Array.isArray(h)?h[c(Math.random()*h.length)]:h;break}return f}weightedRandomize(a,b,c,d,e){let f=e.map(b=>b.weight),g=0;f.forEach(a=>{g+=a});let h=this;for(let f=b;f<=b+d;f++)for(let b,d=a;d<=a+c;d++)b=this._match(g,e),this.tiles[d+f*this.data.height]=new Sprite$1({image:h.sheet[b],renderable:!0}),this._includeCollider(b,this.tiles[d+f*this.data.height])}placeTile(a,b,c){let d=this;this.tiles[b+c*this.data.height]=new Sprite$1({image:d.sheet[a],renderable:!0}),this._includeCollider(a,this.tiles[b+c*this.data.height])}tileToWorldX(a){return-1*(this.data.width*this.data.tileWidth/2)+a*this.data.tileWidth}tileToWorldY(a){return-1*(this.data.height*this.data.tileHeight/2)+a*this.data.tileHeight}placeTiles(a,b,c){Array.isArray(a[0])||(a=[a]);for(var d=a.length,e=a[0].length,f=0;f<d;f++)for(var g,h=0;h<e;h++)g=a[f][h],this.placeTile(g,b+h,c+f)}fill(a,b,c,d,e){for(let f=c;f<c+e;f++)for(let c=b;c<b+d;c++)this.placeTile(a,c,f)}render(a){let b=-1*(this.data.width*this.data.tileWidth/2),c=-1*(this.data.height*this.data.tileHeight/2);for(var d in this.tiles){let e=this.tiles[d];e&&(e.x=b+this.x,e.y=c+this.y,e.render(a)),b+=this.data.tileWidth,b>this.data.tileWidth*this.data.width/2-this.data.tileWidth&&(b=-1*(this.data.width*this.data.tileWidth/2),c+=this.data.tileHeight)}}}window.Pixel={Stage:Stage,Sprite:Sprite$1,AnimatedSprite:AnimatedSprite,Texture:Texture,Rectangle:Rectangle,Circle:Circle,Text:Text,Sound:Sound,Point:Point,Container:Container,Graphics:Graphics,SpriteSheet:SpriteSheet,Keys:{1:"1",2:"2",3:"3",4:"4",5:"5",6:"6",7:"7",8:"8",9:"9",0:"0",TAB:"Tab",SHIFT:"Shift",COMMA:",",PERIOD:".",BACKSLASH:"/",TILDE:"~",EXCLAMATION:"!",ATSIGN:"@",HASHTAG:"#",DOLLARSIGN:"$",PERCENT:"%",DASH:"-",UNDERSCORE:"_",PLUS:"+",QUESTIONMARK:"?",A:"a",B:"b",C:"c",D:"d",E:"e",F:"f",G:"g",H:"h",I:"i",J:"j",K:"k",L:"l",M:"m",N:"n",O:"o",P:"p",Q:"q",R:"r",S:"s",T:"t",U:"u",V:"v",W:"w",X:"x",Y:"y",Z:"z",UP:"ArrowUp",DOWN:"ArrowDown",LEFT:"ArrowLeft",RIGHT:"ArrowRight",down:{1:!1,2:!1,3:!1,4:!1,5:!1,6:!1,7:!1,8:!1,9:!1,0:!1,TAB:!1,SHIFT:!1,COMMA:!1,PERIOD:!1,BACKSLASH:!1,TILDE:!1,EXCLAMATION:!1,ATSIGN:!1,HASHTAG:!1,DOLLARSIGN:!1,PERCENT:!1,DASH:!1,UNDERSCORE:!1,PLUS:!1,QUESTIONMARK:!1,A:!1,B:!1,C:!1,D:!1,E:!1,F:!1,G:!1,H:!1,I:!1,J:!1,K:!1,L:!1,M:!1,N:!1,O:!1,P:!1,Q:!1,R:!1,S:!1,T:!1,U:!1,V:!1,W:!1,X:!1,Y:!1,Z:!1,UP:!1,DOWN:!1,LEFT:!1,RIGHT:!1}},Map:Map,EXPORTS:{SpriteBase:SpriteBase,AnimationCore:AnimationCore,FillStyle:FillStyle,ImageGraphics:ImageGraphics}},window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(a){return setTimeout(a,1e3/60)};
