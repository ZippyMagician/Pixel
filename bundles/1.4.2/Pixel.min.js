/*
  Copyright (c) Joshua Barnett 2019
  All rights reserved
*/

class Point{constructor(t=0,e=0){this.x=t,this.y=e}clone(){return new Point(this.x,this.y)}}class Stage{constructor(t,e,i={ticker:!0}){var s=this,r=document.createElement("canvas"),h=r.getContext("2d");h.canvas.height=e,h.canvas.width=t,this.view=h.canvas,this.draw=h,this.tick=!1,this.cursor=r.style.cursor,this.onclick,this.onmousemove,this.onkeydown,this.onmousedown,this.elements={sprites:[]},this.resources={},this.stage={add:{},clear:{},regions:{}},this.stage.mousePos=function(t){var e=r.getBoundingClientRect(),i=r.width/e.width,s=r.height/e.height;return{x:(t.clientX-e.left)*i,y:(t.clientY-e.top)*s}},this._checkRegions=function(t,e=!0){var i=!1,h=s.stage.mousePos(t);for(var n in s.stage.regions){var a=s.stage.regions[n];h.x>a.start.x&&h.x<a.end.x&&h.y>a.start.y&&h.y<a.end.y&&(e?a.call():r.style.cursor="pointer",i=!0)}return i},this.view.onclick=function(t){if(s._checkRegions(t),s.onclick)return s.onclick(t)},document.onmousemove=function(t){if(s._checkRegions(t,!1)||(r.style.cursor=s.cursor),s.onmousemove)return s.onmousemove(t)},this.view.onkeydown=function(t){if(s.onkeydown)return s.onkeydown(t)},this.view.onmousedown=function(t){if(s.onmousedown)return s.onmousedown(t)},this.view.onmouseup=function(t){if(s.onmouseup)return s.onmouseup(t)},this.elements.add=function(t="default",e={id:"rect",h:10,w:10,color:"#000000"}){return s.resources[t]=e,s.loader},this.stage.add=function(t){return t.render(h)},this.stage.clear=function(){h.clearRect(0,0,h.canvas.width,h.canvas.height)},this.stage.on=function(t,e){s["on"+t]=e},this.stage.addHitRegion=function(t,e){s.stage.regions[t.name]=new Object(Object.assign({call:e},t))},i.ticker&&this._animFrame(this)}addChild(t){this.elements.sprites.push(t)}removeChildren(){this.elements.sprites=[]}_animFrame(t){t.elements.sprites.length>=1&&t.screen.clear();for(var e=0;e<t.elements.sprites.length;e++)t.screen.add(t.elements.sprites[e]);requestAnimationFrame(t._tick.bind(!1,t)),requestAnimationFrame(t._animFrame.bind(!1,t))}_tick(t){t.tick&&t.tick()}render(){var t=this.elements.sprites.length;t>=1&&this.screen.clear();for(var e=0;e<t;e++)this.screen.add(this.elements.sprites[e])}}class SpriteBase{constructor(t=!1){this.point=new Point,this.anchor=new Point,this.opacity=1,this.deg=0,this.scale=1,this.noscale=t}get x(){return this.point.x}set x(t){return this.point.x=t}get y(){return this.point.y}set y(t){return this.point.y=t}setAnchor(t,e){this.anchor.x=t,this.anchor.y=e}spin(t){this.deg=360*t}settings(t){this.noscale||(t.globalAlpha=this.opacity),t.scale(this.scale,this.scale)}reset(t){t.globalAlpha=1,this.noscale||t.scale(1/this.scale,1/this.scale)}}class Sprite extends SpriteBase{constructor(t){super();this.texture=t}render(t){this.texture.renderable&&(this.settings(t),this.deg>0?this.rotation_render(t):t.drawImage(this.texture.image,this.x/this.scale-this.texture.image.width*this.anchor.x,this.y/this.scale-this.texture.image.height*this.anchor.y),this.reset(t))}rotation_render(t){var e=this.texture.image;t.save(),t.translate(this.x/this.scale,this.y/this.scale),t.fillStyle="#000000",t.rotate(Math.PI/180*this.deg),t.drawImage(e,-e.width*this.anchor.x,-e.height*this.anchor.y),t.restore()}clone(){return new Sprite(this.texture)}}class Rectangle extends SpriteBase{constructor(t,e,i="#000000"){super(!0),this.width=t,this.height=e,this.color=i}render(t){this.settings(t),this.deg>0?this.rotation_render(t):(t.fillStyle=this.color,t.fillRect(this.x-this.width*this.anchor.x,this.y-this.height*this.anchor.y,this.width,this.height),t.fill()),this.reset(t)}rotation_render(t){t.save(),t.translate(this.x,this.y),t.rotate(Math.PI/180*this.deg),t.fillStyle=this.color,t.fillRect(0-this.width*this.anchor.x,0-this.height*this.anchor.y,this.width,this.height),t.fill(),t.restore()}}class Circle extends SpriteBase{constructor(t,e="#000000"){super(!0),this.radius=t,this.color=e}render(t){this.settings(t),t.beginPath(),t.fillStyle=this.color,t.arc(this.x,this.y,this.radius,0,2*Math.PI),t.fill(),this.reset(t)}}class Text extends SpriteBase{constructor(t,e,i="#000000"){super(),this.text=t,this.size=e,this.color=i}render(t){this.settings(t),t.beginPath(),t.fillStyle=this.color,t.font=this.size+"px Verdana",t.fillText(this.text,this.x,this.y),t.fill(),this.reset(t)}}class Container{constructor(){this.contents=[],this.container=!0,this.point=new Point}addChild(t){this.contents.push(t)}cloneChildren(t){var e=this.contents;for(var i in e)t.addChild(e[i])}get x(){return this.point.x}get y(){return this.point.y}set x(t){var e=this.contents;for(var i in e){var s=e[i];s.x=s.x+(t-this.x)}this.point.x=t}set y(t){var e=this.contents;for(var i in e){var s=e[i];s.y=s.y+(t-this.y)}this.point.y=t}render(t){var e=this.contents;for(var i in e)e[i].render(t)}}class Sound{constructor(){}}class Texture{constructor(t){var e=this;this.image="string"==typeof t?new Image:t,this.renderable="string"!=typeof t,"string"==typeof t&&(this.image.onload=function(){e.renderable=!0},this.image.src=t)}}class FillStyle{constructor(){this.reset()}reset(){this.color=16777215,this.alpha=1}clone(){var t=new FillStyle;return t.color=this.color,t.alpha=this.alpha,t}fill(t){return this.color=t,this.color}}class ImageGraphics{constructor(t){this.ctx=t,this.cctx,this.canvas,this.image=new Image,this.renderabe=!1,this.width=0,this.height=0,this.math=!1}loadImage(t){var e=this;return new Promise(function(i,s){e.image.onload=function(){return e.renderable=!0,e.math=!0,e.width=e.image.width,e.height=e.image.height,i(e)},e.image.src=t})}cropRect(t,e,i,s){this.canvas=document.createElement("canvas"),this.cctx=this.canvas.getContext("2d"),this.cctx.canvas.width=this.width,this.cctx.canvas.height=this.height,this.cctx.drawImage(this.image,0,0);var r=this.cctx.getImageData(t,e,i,s);return this.cctx.clearRect(0,0,this.width,this.height),this.canvas.width=i,this.canvas.height=s,this.cctx.putImageData(r,0,0),new Sprite(new Texture(this.canvas))}}class Graphics extends ImageGraphics{constructor(t){super(t),this.ctx=t,this.dsc=this.ctx.shadowColor,this._fillStyle=new FillStyle}transparency(t){return this.ctx.globalAlpha=t,this}shadow(t,e,i,s){return this.ctx.shadowBlur=t,this.ctx.shadowColor=e,this.ctx.shadowOffsetX=i,this.ctx.shadowOffsetY=s,this}fill(t){return this.ctx.fillStyle=this._fillStyle.fill(t),this}text(t,e,i,s,r){return this.ctx.beginPath(),this.ctx.font=s+"px Verdana",this.ctx.fillText(t,e,i),this.ctx.fill(),this}end(){this._fillStyle.reset(),this.ctx.fillStyle="#000000",this.ctx.shadowBlur=0,this.ctx.shadowColor=this.dsc,this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0,this.ctx.globalAlpha=1}drawRect(t,e,i,s){return this.ctx.fillRect(t,e,i,s),this}arc(t,e,i,s,r,h=!1){return this.ctx.beginPath(),this.ctx.arc(t,e,i,s,r,h),this.ctx.fill(),this}arcTo(t,e,i,s,r){return this.ctx.beginPath(),this.ctx.arcTo(t,e,i,s,r),this.ctx.fill(),this}move(t,e){return this.ctx.moveTo(t,e),this}clearRect(t,e,i,s){return this.ctx.clearRect(t,e,i,s),this}clearCircle(t,e,i){this.ctx.globalCompositeOperation="destination-out",this.ctx.arc(t,e,i,0,2*Math.PI),this.ctx.fill(),this.ctx.globalCompositeOperation="source-over"}}window.Pixel={App:Stage,Sprite:Sprite,Texture:Texture,Rectangle:Rectangle,Circle:Circle,Text:Text,Sound:Sound,Point:Point,Container:Container,Graphics:Graphics},window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return setTimeout(t,1e3/60)};
