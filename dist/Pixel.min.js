class Point{constructor(t=0,e=0){this.x=t,this.y=e}clone(){return new Point(this.x,this.y)}}function chooseRandom(t){return t[Math.floor(Math.random()*(t.length-1))]}var _pixel_keys={1:"1",2:"2",3:"3",4:"4",5:"5",6:"6",7:"7",8:"8",9:"9",0:"0",TAB:"Tab",SHIFT:"Shift",COMMA:",",PERIOD:".",BACKSLASH:"/",TILDE:"~",EXCLAMATION:"!",ATSIGN:"@",HASHTAG:"#",DOLLARSIGN:"$",PERCENT:"%",DASH:"-",UNDERSCORE:"_",PLUS:"+",QUESTIONMARK:"?",A:"a",B:"b",C:"c",D:"d",E:"e",F:"f",G:"g",H:"h",I:"i",J:"j",K:"k",L:"l",M:"m",N:"n",O:"o",P:"p",Q:"q",R:"r",S:"s",T:"t",U:"u",V:"v",W:"w",X:"x",Y:"y",Z:"z",UP:"ArrowUp",DOWN:"ArrowDown",LEFT:"ArrowLeft",RIGHT:"ArrowRight",down:{1:!1,2:!1,3:!1,4:!1,5:!1,6:!1,7:!1,8:!1,9:!1,0:!1,TAB:!1,SHIFT:!1,COMMA:!1,PERIOD:!1,BACKSLASH:!1,TILDE:!1,EXCLAMATION:!1,ATSIGN:!1,HASHTAG:!1,DOLLARSIGN:!1,PERCENT:!1,DASH:!1,UNDERSCORE:!1,PLUS:!1,QUESTIONMARK:!1,A:!1,B:!1,C:!1,D:!1,E:!1,F:!1,G:!1,H:!1,I:!1,J:!1,K:!1,L:!1,M:!1,N:!1,O:!1,P:!1,Q:!1,R:!1,S:!1,T:!1,U:!1,V:!1,W:!1,X:!1,Y:!1,Z:!1,UP:!1,DOWN:!1,LEFT:!1,RIGHT:!1}};class Stage{constructor(t){var e=this,i=document.createElement("canvas");i.height=t.height,i.width=t.width;var s=i.getContext("2d");this.view=s.canvas,this.draw=s,this.tick=!1,this.cursor=i.style.cursor,this._backColor="#FFFFFF",this.elements={sprites:[]},this.resources={},this.stage={add:{},clear:{},regions:{},keyboard:{},mouse:{}},this.physics={collider:{},collisions:[],colliding:{}},this.physics.collider.add=function(t,i,s){e.physics.collisions.push({name:t,parent:i,child:s}),e.physics.colliding[t]=!1},this.stage.mousePos=function(t){var e=i.getBoundingClientRect(),s=i.width/e.width,h=i.height/e.height;return{x:(t.clientX-e.left)*s,y:(t.clientY-e.top)*h}},this.stage.background=function(t){e._backColor=t},this._checkRegions=function(t,s=!0){var h=!1,r=e.stage.mousePos(t);for(var a in e.stage.mouse=r,e.stage.regions){var n=e.stage.regions[a];r.x>n.start.x&&r.x<n.end.x&&r.y>n.start.y&&r.y<n.end.y&&(s?n.call():i.style.cursor="pointer",h=!0)}return h},this.view.onclick=function(t){if(e._checkRegions(t),e.onclick)return e.onclick(t)},document.onmousemove=function(t){if(e._checkRegions(t,!1)||(i.style.cursor=e.cursor),e.onmousemove)return e.onmousemove(t)},document.onmousedown=function(t){if(e.lastClickTarget=t.target,e.onmousedown)return e.onmousedown(t)},document.onkeydown=function(t){let i=t.key,s=_pixel_keys;for(var h in s)i===s[h]&&(s.down[h]=!0);if(e.onkeydown)return e.onkeydown(t)},document.onkeyup=function(t){let i=t.key,s=_pixel_keys;for(var h in s)i===s[h]&&(s.down[h]=!1);if(e.onkeyup)return e.onkeyup(t)},this.elements.add=function(t="default",i=""){var s=new Image;return new Promise(function(h,r){s.onload=function(){return e.resources[t]={image:s,renderable:!0},h(e.resources)},s.crossOrigin="Anonymous",s.src=i})},this.stage.add=function(t){return t.render(s)},this.stage.clear=function(){s.clearRect(0,0,s.canvas.width,s.canvas.height)},this.stage.on=function(t,i){"mousemove"===t||"mousedown"===t||"click"===t?e["on"+t]=i:e.view.addEventListener(t,i)},this.stage.keyboard.on=function(t,i){"keydown"===t||"keyup"===t?e["on"+t]=i:document["on"+t]=i},this.stage.addHitRegion=function(t,i){e.stage.regions[t.name]=new Object(Object.assign({call:i},t))},(void 0===t.ticker|null||t.ticker)&&this._animFrame(this)}addChild(t){this.elements.sprites.push(t)}removeChildren(){this.elements.sprites=[]}render(t){var e=t.elements.sprites.length;e>=1&&t.stage.clear(),t.draw.fillStyle=t._backColor,t.draw.fillRect(0,0,t.view.width,t.view.height);for(var i=0;i<e;i++)t.stage.add(t.elements.sprites[i])}_checkCollisions(t){for(let e in t.physics.collisions){let i=t.physics.collisions[e],s=i.name,h=i.parent,r={top:!1,bottom:!1,left:!1,right:!1,body:!1};if(Array.isArray(h))for(let t in h){let e=h[t].checkCollisions(i.child);r.body=!0===e.body||!0===r.body,r.left=!0===e.left||!0===r.left,r.right=!0===e.right||!0===r.right,r.bottom=!0===e.bottom||!0===r.bottom,r.top=!0===e.top||!0===r.top}else r=h.checkCollisions(i.child);t.physics.colliding[s]=r}}_animFrame(t){t.render(t),requestAnimationFrame(t._checkCollisions.bind(!1,t)),requestAnimationFrame(t._tick.bind(!1,t)),requestAnimationFrame(t._animFrame.bind(!1,t))}_tick(t){t.tick&&t.tick()}}class SpriteBase{constructor(t=!1){this.point=new Point,this.anchor=new Point,this.opacity=1,this.deg=0,this.scale=1,this.noscale=t,this.flipX=!1,this.flipY=!1}setSize(t,e){this.width=t,this.height=e}get x(){return this.point.x}set x(t){return this.point.x=t}get y(){return this.point.y}set y(t){return this.point.y=t}setAnchor(t,e){this.anchor.x=t,this.anchor.y=e}copy(t){this.point=t.point,this.deg=t.deg,this.anchor=t.anchor,this.flipX=t.flipX,this.flipY=t.flipY,this.opacity=t.opacity,this.scale=t.scale}spin(t){this.deg=360*t}settings(t){this.noscale||(t.globalAlpha=this.opacity),t.scale(this.scale,this.scale)}reset(t){t.globalAlpha=1,this.noscale||t.scale(1/this.scale,1/this.scale)}}class Sprite extends SpriteBase{constructor(t){super(),this.texture=t}render(t){this.texture.renderable&&(this.settings(t),this.deg>0||this.flipX||this.flipY?this.rotation_render(t):t.drawImage(this.texture.image,this.x/this.scale-this.texture.image.width*this.anchor.x,this.y/this.scale-this.texture.image.height*this.anchor.y),this.reset(t))}rotation_render(t){var e=this.texture.image;t.save(),t.translate(this.x/this.scale,this.y/this.scale),this.flipX&&t.scale(-1,1),this.flipY&&t.scale(1,-1),t.fillStyle="#000000",t.rotate(Math.PI/180*this.deg),t.drawImage(e,-e.width*this.anchor.x,-e.height*this.anchor.y),t.restore()}checkCollisions(t){var e=this.x/this.scale-this.texture.image.width*this.anchor.x,i=e+this.texture.image.width,s=this.y/this.scale-this.texture.image.height*this.anchor.y,h=s+this.texture.image.height,r=t.x/t.scale-(t.width||t.texture.image.width)*t.anchor.x,a=r+(t.width||t.texture.image.width)/t.scale,n=t.y/t.scale-(t.height||t.texture.image.height)*t.anchor.y,o=n+(t.height||t.texture.image.height)/t.scale,l=!0,c=!1,d=!1,g=!1,u=!1;return(h<n||s>o||i<r||e>a)&&(l=!1),l&&(h-0>o&&s+0<o&&(u=!0),s+0<n&&h-0>n&&(g=!0),e+0<r&&i-0>r&&(c=!0),i-0>a&&e+0<a&&(d=!0)),{body:l,left:c,right:d,top:g,bottom:u}}clone(){return new Sprite(this.texture)}}class AnimationCore{constructor(t){this.parent=t,this.frame=0,this.cache=[],this.tracks={},this.current=!1,this.track}stop(t){let e=new Sprite({renderable:!0,image:this.cache[t-1].image});this.current=[e],this.frame=0}play(t){this.track!==t&&(this.frame=0),this.current=this.tracks[t],this.track=t}add(t,e,i=0){var s=i,h=this.cache,r=[];for(var a in h){var n=h[a];if(n.name.startsWith(e)&&0===s){var o=new Sprite({renderable:!0,image:n.image});r.push(o)}else s>0&&s--}r.length>0&&(this.tracks[t]=r)}create(t){let e=t.name,i=t.positions[0],s=t.positions[1],h=this.cache,r=[];for(var a=i-1;a<s;a++){var n=new Sprite({renderable:!0,image:h[a].image});r.push(n)}this.tracks[e]=r}multiAdd(t){for(var e in t){let i=t[e],s=i.name,h=i.filter,r=i.offset;this.add(s,h,r)}}group(t,e,i=0){return{name:t,filter:e,offset:i}}}class AnimatedSprite extends SpriteBase{constructor(t,e,i=1){super(),this.animation=new AnimationCore(this),this.speed=i,this.texture={image:new Image},this.config?(this.config=t,this.texture=e,this._splitFrames()):(this.sheet=e,this._splitSheetFrames())}_splitFrames(){var t=this.config;for(var e in t.textures[0].frames){let i=t.textures[0].frames[e];this.animation.cache.push({name:i.name,image:this._slice(i.position.x,i.position.y,i.position.w,i.position.h)})}}_splitSheetFrames(){for(var t in this.sheet){let e=this.sheet[t];this.animation.cache.push({name:t.toString(),image:e})}}_slice(t,e,i,s){var h=document.createElement("canvas"),r=h.getContext("2d");r.canvas.width=this.texture.image.width,r.canvas.height=this.texture.image.height,r.drawImage(this.texture.image,0,0);var a=r.getImageData(t,e,i,s);return r.clearRect(0,0,this.texture.image.width,this.texture.image.height),h.width=i,h.height=s,r.putImageData(a,0,0),h}render(t){if(this.animation.current){var e=this.animation.current[Math.floor(this.animation.frame)%this.animation.current.length];e.copy(this),this.texture=e.texture,e.render(t),this.animation.frame+=this.speed}}}class SpriteSheet extends SpriteBase{constructor(t,e){if(super(),!t.renderable)throw new Error("PixelError: Texture passed to Pixel#SpriteSheet constructor MUST be loaded");this.texture=t,this.sheet=[],this._parse(e)}_slice(t,e,i,s,h=!1){let r=h||this.texture,a=document.createElement("canvas"),n=a.getContext("2d");n.canvas.width=r.width?r.width:r.image.width,n.canvas.height=r.height?r.height:r.image.height,n.drawImage(r.width?r:r.image,0,0);let o=n.getImageData(t,e,i,s);return a.width=i,a.height=s,n.putImageData(o,0,0),a}trim(t){let e=t.width,i=t.height,s=this.sheet[0].width,h=this.sheet[0].height;for(let t in this.sheet){let r=this.sheet[t],a=s-e,n=h-i;this.sheet[t]=this._slice(a/2,n/2,e-a/2,i-n/2,r)}}_parse(t){let e,i,s=this.texture.image.width,h=this.texture.image.height,r=Math.floor(s/t.width),a=Math.floor(h/t.height),n=t.margin||0,o=t.spacing||0;for(i=1;i<=a;i++)for(e=1;e<=r;e++){let s=this._slice(e*(t.width+o)-t.width,i*(t.height+o+n)-t.height,t.width-n-o,t.height-n-o);this.sheet.push(s)}}generateSheet(){return this.sheet}}class Map extends SpriteBase{constructor(t,e){super(),this.sheet=t,this.data=e,this.tiles=[],this.exclude,this.colliders=[]}_includeCollider(t,e){if(this.exclude){!(this.exclude.indexOf(t)>-1)&&this.colliders.push(e)}}applyTileset(t){let e=this.data.height,i=this.data.width,s=this;for(var h=0;h<e;h++){for(var r=0;r<i;r++){let e=t[h][r],i=!!this.sheet[e]&&new Sprite({image:s.sheet[e],renderable:!0});this.tiles.push(i),i&&this._includeCollider(e,i)}r=0}}generateBlankMap(){for(var t=0;t<this.data.height;t++)for(var e=0;e<this.data.width;e++)this.tiles.push(!1)}collideByExclusion(t){this.exclude=t}checkCollisions(t){let e={body:!1,top:!1,bottom:!1,left:!1,right:!1};for(let i=0;i<this.colliders.length;i++){let s=this.colliders[i].checkCollisions(t);e.body=!0===s.body||!0===e.body,e.left=!0===s.left||!0===e.left,e.right=!0===s.right||!0===e.right,e.bottom=!0===s.bottom||!0===e.bottom,e.top=!0===s.top||!0===e.top}return e}_match(t,e){let i=Math.random()*t;for(var s=0,h=-1,r=0;r<e.length;r++)if(i<=(s+=e[r].weight)){var a=e[r].index;h=Array.isArray(a)?a[Math.floor(Math.random()*a.length)]:a;break}return h}weightedRandomize(t,e,i,s,h){let r=h.map(t=>t.weight),a=0;r.forEach(t=>{a+=t});let n=this;for(let r=e;r<=e+s;r++)for(let e=t;e<=t+i;e++){let t=this._match(a,h);this.tiles[e+r*this.data.height]=new Sprite({image:n.sheet[t],renderable:!0}),this._includeCollider(t,this.tiles[e+r*this.data.height])}}placeTile(t,e,i){this.tiles[e+i*this.data.height]=new Sprite({image:this.sheet[t],renderable:!0}),this._includeCollider(t,this.tiles[e+i*this.data.height])}tileToWorldX(t){return this.data.width*this.data.tileWidth/2*-1+t*this.data.tileWidth}tileToWorldY(t){return this.data.height*this.data.tileHeight/2*-1+t*this.data.tileHeight}placeTiles(t,e,i,s,h){Array.isArray(t[0])||(t=[t]);for(var r=t.length,a=t[0].length,n=0;n<r;n++)for(var o=0;o<a;o++){var l=t[n][o];this.placeTile(l,e+o,i+n)}}fill(t,e,i,s,h){for(let r=i;r<i+h;r++)for(let i=e;i<e+s;i++)this.placeTile(t,i,r)}render(t){let e=this.data.width*this.data.tileWidth/2*-1,i=this.data.height*this.data.tileHeight/2*-1;for(var s in this.tiles){let h=this.tiles[s];h&&(h.x=e+this.x,h.y=i+this.y,h.render(t)),(e+=this.data.tileWidth)>this.data.tileWidth*this.data.width/2-this.data.tileWidth&&(e=this.data.width*this.data.tileWidth/2*-1,i+=this.data.tileHeight)}}}class Rectangle extends SpriteBase{constructor(t,e,i="#000000"){super(!0),this.width=t,this.height=e,this.color=i}render(t){this.settings(t),this.deg>0||this.flipX||this.flipY?this.rotation_render(t):(t.fillStyle=this.color,t.fillRect(this.x-this.width*this.anchor.x,this.y-this.height*this.anchor.y,this.width,this.height),t.fill()),this.reset(t)}rotation_render(t){t.save(),t.translate(this.x,this.y),this.flipX&&t.scale(-1,1),this.flipY&&t.scale(1,-1),t.rotate(Math.PI/180*this.deg),t.fillStyle=this.color,t.fillRect(0-this.width*this.anchor.x,0-this.height*this.anchor.y,this.width,this.height),t.fill(),t.restore()}}class Circle extends SpriteBase{constructor(t,e="#000000"){super(!0),this.radius=t,this.color=e}render(t){this.settings(t),t.beginPath(),t.fillStyle=this.color,t.arc(this.x,this.y,this.radius,0,2*Math.PI),t.fill(),this.reset(t)}}class Text extends SpriteBase{constructor(t,e,i="#000000"){super(),this.text=t,this.size=e,this.color=i}render(t){this.settings(t),t.beginPath(),t.fillStyle=this.color,t.font=this.size+"px Verdana",t.fillText(this.text,this.x,this.y),t.fill(),this.reset(t)}}class Container{constructor(){this.contents=[],this.container=!0,this.point=new Point}addChild(t){this.contents.push(t)}cloneChildren(t){var e=this.contents;for(var i in e)t.addChild(e[i])}get x(){return this.point.x}get y(){return this.point.y}set x(t){var e=this.contents;for(var i in e){var s=e[i];s.x=s.x+(t-this.x)}this.point.x=t}set y(t){var e=this.contents;for(var i in e){var s=e[i];s.y=s.y+(t-this.y)}this.point.y=t}render(t){var e=this.contents;for(var i in e)e[i].render(t)}}class Sound{constructor(){}}class Texture{constructor(t){var e=this;this.image="string"==typeof t?new Image:t,this.renderable="string"!=typeof t,"string"==typeof t&&(this.image.onload=function(){e.renderable=!0},this.image.src=t)}}class FillStyle{constructor(){this.reset()}reset(){this.color=16777215,this.alpha=1}clone(){var t=new FillStyle;return t.color=this.color,t.alpha=this.alpha,t}fill(t){return this.color=t,this.color}}class ImageGraphics{constructor(t){this.ctx=t,this.cctx,this.canvas,this.image=new Image,this.renderabe=!1,this.width=0,this.height=0,this.math=!1}loadImage(t){var e=this;return new Promise(function(i,s){e.image.onload=function(){return e.renderable=!0,e.math=!0,e.width=e.image.width,e.height=e.image.height,i(e)},e.image.src=t})}cropRect(t,e,i,s){this.canvas=document.createElement("canvas"),this.cctx=this.canvas.getContext("2d"),this.cctx.canvas.width=this.width,this.cctx.canvas.height=this.height,this.cctx.drawImage(this.image,0,0);var h=this.cctx.getImageData(t,e,i,s);return this.cctx.clearRect(0,0,this.width,this.height),this.canvas.width=i,this.canvas.height=s,this.cctx.putImageData(h,0,0),new Sprite(new Texture(this.canvas))}}class Graphics extends ImageGraphics{constructor(t){super(t),this.ctx=t,this.dsc=this.ctx.shadowColor,this._fillStyle=new FillStyle}transparency(t){return this.ctx.globalAlpha=t,this}shadow(t,e,i,s){return this.ctx.shadowBlur=t,this.ctx.shadowColor=e,this.ctx.shadowOffsetX=i,this.ctx.shadowOffsetY=s,this}fill(t){return this.ctx.fillStyle=this._fillStyle.fill(t),this}text(t,e,i,s,h){return this.ctx.beginPath(),this.ctx.font=s+"px Verdana",this.ctx.fillText(t,e,i),this.ctx.fill(),this}end(){this._fillStyle.reset(),this.ctx.fillStyle="#000000",this.ctx.shadowBlur=0,this.ctx.shadowColor=this.dsc,this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0,this.ctx.globalAlpha=1}drawRect(t,e,i,s){return this.ctx.fillRect(t,e,i,s),this}arc(t,e,i,s,h,r=!1){return this.ctx.beginPath(),this.ctx.arc(t,e,i,s,h,r),this.ctx.fill(),this}arcTo(t,e,i,s,h){return this.ctx.beginPath(),this.ctx.arcTo(t,e,i,s,h),this.ctx.fill(),this}move(t,e){return this.ctx.moveTo(t,e),this}clearRect(t,e,i,s){return this.ctx.clearRect(t,e,i,s),this}clearCircle(t,e,i){this.ctx.globalCompositeOperation="destination-out",this.ctx.arc(t,e,i,0,2*Math.PI),this.ctx.fill(),this.ctx.globalCompositeOperation="source-over"}}window.Pixel={App:Stage,Sprite:Sprite,AnimatedSprite:AnimatedSprite,Texture:Texture,Rectangle:Rectangle,Circle:Circle,Text:Text,Sound:Sound,Point:Point,Container:Container,Graphics:Graphics,SpriteSheet:SpriteSheet,Keys:_pixel_keys,Map:Map,EXPORTS:{SpriteBase:SpriteBase,AnimationCore:AnimationCore}},window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return setTimeout(t,1e3/60)};
